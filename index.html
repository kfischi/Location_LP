<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - ניהול לידים ונכסים</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <h1 class="text-2xl font-bold mb-4">מערכת CRM לניהול לידים ונכסים</h1>

    <!-- Tabs -->
    <div class="flex space-x-4 border-b mb-4">
        <button class="tab-btn px-4 py-2 tab-active" data-tab="leads">לידים</button>
        <button class="tab-btn px-4 py-2" data-tab="properties">נכסים</button>
    </div>

    <!-- Leads Section -->
    <div id="leads" class="tab-content">
        <div class="mb-4">
            <input type="text" id="leadSearch" placeholder="חיפוש לידים..." class="border p-2 rounded w-full">
        </div>
        <div id="leadsList" class="grid gap-4"></div>
    </div>

    <!-- Properties Section -->
    <div id="properties" class="tab-content hidden">
        <div class="mb-4">
            <input type="text" id="propertySearch" placeholder="חיפוש נכסים..." class="border p-2 rounded w-full">
        </div>
        <div id="propertiesList" class="grid gap-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // --- חיבור ל-Supabase ---
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_KEY = 'your-anon-key';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- נתונים ---
        let leads = [];
        let properties = [];

        // --- טען לידים ---
        async function loadLeads() {
            const { data, error } = await supabaseClient.from('leads').select('*');
            if (!error && data) {
                leads = data;
                localStorage.setItem('leads', JSON.stringify(leads));
                renderLeads();
            }
        }

        // --- טען נכסים ---
        async function loadProperties() {
            const { data, error } = await supabaseClient.from('properties').select('*');
            if (!error && data) {
                properties = data;
                localStorage.setItem('properties', JSON.stringify(properties));
                renderProperties();
            }
        }

        // --- טעינה מ-localStorage ---
        if (localStorage.getItem('leads')) leads = JSON.parse(localStorage.getItem('leads'));
        if (localStorage.getItem('properties')) properties = JSON.parse(localStorage.getItem('properties'));

        // --- Tabs ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(btn.dataset.tab).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                btn.classList.add('tab-active');
            });
        });

        // --- חיפוש לידים ---
        document.getElementById('leadSearch').addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            const filtered = leads.filter(l => l.name.toLowerCase().includes(term) || l.phone.includes(term));
            renderLeads(filtered);
        });

        // --- חיפוש נכסים ---
        document.getElementById('propertySearch').addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            const filtered = properties.filter(p => 
                p.title.toLowerCase().includes(term) ||
                p.location.toLowerCase().includes(term) ||
                p.amenities.some(a => a.toLowerCase().includes(term))
            );
            renderProperties(filtered);
        });

        // --- Render Leads (כרטיסים צבעוניים) ---
        function renderLeads(list = leads) {
            const statusColors = {
                'חדש': 'bg-green-100 border-green-400',
                'בתהליך': 'bg-yellow-100 border-yellow-400',
                'נסגר': 'bg-red-100 border-red-400'
            };

            document.getElementById("leadsList").innerHTML = list.map(lead => `
                <div class="p-4 rounded border ${statusColors[lead.status] || 'bg-gray-100 border-gray-400'} shadow">
                    <div class="flex justify-between items-center">
                        <h2 class="font-bold text-lg">${lead.name}</h2>
                        <a href="tel:${lead.phone}" class="text-blue-600 hover:underline">📞</a>
                    </div>
                    <p class="text-sm text-gray-600">טלפון: ${lead.phone}</p>
                    <p class="text-sm text-gray-500">סטטוס: ${lead.status}</p>
                    ${lead.notes ? `<p class="mt-2 text-gray-700 text-sm">${lead.notes}</p>` : ''}
                </div>
            `).join('');
        }

        // --- Render Properties ---
        function renderProperties(list = properties) {
            document.getElementById("propertiesList").innerHTML = list.map(property => `
                <div class="bg-white shadow rounded p-4">
                    <h2 class="text-lg font-bold mb-2">${property.title}</h2>
                    <div class="flex flex-wrap gap-2 mb-2">
                        ${property.amenities.map(amenity => `
                            <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">${amenity}</span>
                        `).join('')}
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        מיקום: ${property.location} | מחיר: ${property.price.toLocaleString()} ₪
                    </p>
                    <p class="text-sm text-gray-500 mt-1">
                        תאריך הוספה: ${new Date(property.dateAdded).toLocaleDateString('he-IL')}
                    </p>
                </div>
            `).join('');
        }

        // --- אתחול ---
        renderLeads();
        renderProperties();
        loadLeads();
        loadProperties();
    </script>
</body>
</html>
